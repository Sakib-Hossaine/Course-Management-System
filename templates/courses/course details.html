{% extends "base.html" %}

{% block styles %}
<style>
/* Udemy-like course detail layout (responsive) */
:root{
    --accent:#0a66c2; /* deep blue */
    --accent-2:#ffb020; /* warm yellow */
    --muted:#6b7280;
    --card:#ffffff;
}
body{font-family:Inter, 'Segoe UI', Arial, sans-serif;color:#111;background:#f6f7fb}
.container{max-width:1100px;margin:28px auto;padding:0 18px}
.page-bg-wrapper{position:fixed;inset:0;z-index:-1;overflow:hidden}
.page-bg-wrapper::before{content:'';position:absolute;inset:-10%;background-image:url('/static/images/course-bg.jpg');background-size:cover;background-position:center;filter:blur(8px) brightness(0.6);transform:scale(1.05)}

.breadcrumb{font-size:1.05rem;color:var(--muted);margin-bottom:10px}
.course-header{display:flex;flex-direction:column;gap:10px;margin-bottom:18px}
.course-title{font-size:2.1rem;font-weight:700;color: #000000;}
.course-sub{color:var(--muted);font-size:1rem}
.meta-row{display:flex;gap:14px;align-items:center;color:var(--muted);font-size:0.95rem}
.page-grid{display:grid;grid-template-columns: 2fr 1fr;gap:24px;align-items:start}
.left-col{background:transparent}
.right-col{position:relative}
.preview-card{background:var(--card);border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06)}
.course-preview{width:100%;height:360px;border-radius:8px;object-fit:cover;background:#ddd;display:flex;align-items:center;justify-content:center;color:#555;font-weight:600}
.course-info{margin-top:14px;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(15,23,42,0.04)}
.features{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
.feature{background:#f3f4f6;padding:8px 10px;border-radius:6px;font-size:0.9rem;color:var(--muted)}
.instructor{display:flex;gap:12px;align-items:center}
.instr-avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;background:#eee}
.instr-meta{font-size:0.95rem}
.rating{color:var(--accent-2);font-weight:700}

.purchase-card{position:sticky;top:88px;background:var(--card);padding:18px;border-radius:10px;box-shadow:0 8px 24px rgba(15,23,42,0.06)}
.price{font-size:1.6rem;font-weight:800;color:#0b3c91}
.price-old{color:var(--muted);text-decoration:line-through;margin-left:8px;font-weight:600}
.buy-cta{margin-top:12px}
.btn{display:inline-block;padding:12px 16px;border-radius:8px;font-weight:700;border:none;cursor:pointer;text-decoration:none}
.btn-primary{background:var(--accent);color:#fff}
.btn-outline{background:#fff;border:1px solid #e5e7eb;color:#111}

@media (max-width:900px){.page-grid{grid-template-columns:1fr}.course-preview{height:220px}.purchase-card{position:relative;top:0}}

/* keep modal styles scoped below (copied & adjusted) */
.buy-modal{position:fixed;inset:0;z-index:9999;display:none;align-items:center;justify-content:center}
.buy-modal-overlay{position:absolute;inset:0;background:rgba(0,0,0,0.45)}
.buy-modal-content{position:relative;background:#fff;border-radius:10px;padding:18px;width:min(700px,96%);max-height:90vh;overflow:auto;box-shadow:0 18px 48px rgba(2,6,23,0.2)}
.buy-close{position:absolute;right:12px;top:8px;border:none;background:transparent;font-size:22px;cursor:pointer}
.payment-form input{width:100%;padding:10px;border-radius:8px;border:1px solid #e5e7eb;margin-top:8px}
.payment-row{display:flex;gap:10px}
.payment-row label{flex:1}
.payment-actions{display:flex;gap:10px;margin-top:12px}

/* Course content accordion styles */
.topic-item{background:transparent;border-radius:8px;margin-top:10px}
.topic-item summary{list-style:none;cursor:pointer;padding:12px 14px;font-weight:700;background:#f8fafc;border-radius:8px;border:1px solid #eef2ff}
.topic-item[open] summary{background:#eef2ff}
.topic-children{padding:10px 14px;border-left:1px solid #eef2ff;border-right:1px solid #eef2ff;border-bottom:1px solid #eef2ff}
.topic-children ul{margin:0;padding-left:18px}
.topic-children li{padding:8px 0;border-bottom:1px dashed #f1f5f9;color:#374151}

</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-bg-wrapper" aria-hidden="true"></div>
    <div class="breadcrumb"><a href="{% url 'courses' %}">Courses</a> &rsaquo; {{ course.title }}</div>

    <header class="course-header">
        <h1 class="course-title">{{ course.title }}</h1>
                <div class="course-sub">By <strong>
                    <a href="{% url 'instructor_courses' course.instructor.id %}" class="instructor-link" style="text-decoration:none;color:inherit">
                        {% if course.instructor.instructor_profile %}
                            {{ course.instructor.instructor_profile.name }}
                        {% else %}
                            {{ course.instructor.get_full_name }}{% if not course.instructor.get_full_name %}{{ course.instructor.username }}{% endif %}
                        {% endif %}
                    </a>
                </strong>{% if course.instructor.instructor_profile and course.instructor.instructor_profile.credentials %}, {{ course.instructor.instructor_profile.credentials }}{% endif %} • Enrollment: {{ course.enrollment_year }}{% if course.topics.all %} • {{ course.topics.count }} topics{% endif %}</div>
    </header>

    <div class="page-grid">
        <div class="left-col">
            <div class="preview-card">
                <!-- preview image/video placeholder -->
                {% if course.image %}
                    <img src="{{ course.image.url }}" alt="{{ course.title }} preview" class="course-preview" />
                {% else %}
                    <div class="course-preview">Course preview</div>
                {% endif %}
            </div>

            <section class="course-info" aria-labelledby="about-title">
                <h2 id="about-title">What you'll learn</h2>
                <div class="features">
                    <span class="feature">{{ course.category }}</span>
                    <span class="feature">Enrollment: {{ course.enrollment_year }}</span>
                    {% if course.topics.all %}<span class="feature">{{ course.topics.count }} topics</span>{% endif %}
                    <span class="feature">Self-paced</span>
                </div>

                <div style="margin-top:12px;color:var(--muted)">
                    <!-- The project currently doesn't store a long description field — use existing fields only. -->
                    A practical, hands-on course to build skills quickly. (Course summary is not available.)
                </div>

                {% if course.topics.all %}
                <div style="margin-top:18px">
                    <h3>Course content</h3>
                    <div class="course-content-list">
                        {# Use Topic and SubTopic models: iterate topics related to this course #}
                        {% if course.topics.all %}
                            {% for topic in course.topics.all %}
                                <details class="topic-item" open="false">
                                    <summary>{{ forloop.counter }}. {{ topic.name }}</summary>
                                    <div class="topic-children">
                                        {% if topic.subtopics.all %}
                                            <ul>
                                                {% for sub in topic.subtopics.all %}
                                                    <li>{{ sub.name }}</li>
                                                {% endfor %}
                                            </ul>
                                        {% else %}
                                            <div style="color:var(--muted);font-size:0.95rem">No sub-topics listed.</div>
                                        {% endif %}
                                    </div>
                                </details>
                            {% endfor %}
                        {% else %}
                            <div style="color:var(--muted);font-size:0.95rem">Course content not provided.</div>
                        {% endif %}
                    </div>
                </div>
                {% endif %}

                <div style="margin-top:18px">
                    <h3>About the instructor</h3>
                    <div class="instructor" style="align-items:flex-start;">
                        <div class="instr-meta">
                            <div style="font-weight:700">{% if course.instructor.instructor_profile %}{{ course.instructor.instructor_profile.name }}{% else %}{{ course.instructor.get_full_name }}{% if not course.instructor.get_full_name %}{{ course.instructor.username }}{% endif %}{% endif %}</div>
                            <div style="color:var(--muted);font-size:0.95rem">{% if course.instructor.instructor_profile %}{{ course.instructor.instructor_profile.credentials }}{% endif %}</div>
                        </div>
                    </div>
                </div>
            </section>
        </div>

        <aside class="right-col">
            <div class="purchase-card">
                <div style="display:flex;justify-content:space-between;align-items:center">
                    <div>
                        <div style="font-size:0.9rem;color:var(--muted)">Price</div>
                        <div class="price">${{ course.current_price }}<span class="price-old">${{ course.original_price }}</span></div>
                    </div>
                    <div style="text-align:right;color:var(--muted);font-size:0.9rem">{{ course.enrollment_year }}</div>
                </div>

                <div class="buy-cta">
                    {% if user.is_authenticated and user == course.instructor %}
                        <a href="{% url 'update_course' course.id %}" class="btn btn-outline">Edit course</a>
                    {% elif not user.is_authenticated or user.user_type != "teacher" %}
                        <form method="post" action="{% url 'start_payment' course.id %}">
                            {% csrf_token %}
                            <button type="submit" id="buy-button" class="btn btn-primary">Buy now</button>
                        </form>
                    {% else %}
                        {# other teachers can view but not edit; show nothing special #}
                    {% endif %}
                </div>

                <div style="margin-top:12px;display:flex;gap:8px">
                    <a href="{% url 'courses' %}" class="btn btn-outline">Back to courses</a>
                    {% if user.is_authenticated and user == course.instructor %}
                        <a href="{% url 'delete_course' course.id %}" class="btn" style="background:#ef4444;color:#fff">Delete</a>
                    {% endif %}
                </div>
            </div>
        </aside>
    </div>

  

</div>

{% endblock %}

{# Modal/payment JS removed from this template per request. Handle JS globally or in an include if needed. #}